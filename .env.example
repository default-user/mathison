# Environment Variables
# Mathison Server Configuration

## Architecture
# mathison-server (port 3000) is the CANONICAL PRODUCT API
# mathison-kernel-mac (port 3001) is DEPRECATED - legacy/dev tooling only

## Required Variables

### Storage Configuration
MATHISON_STORE_BACKEND=FILE
MATHISON_STORE_PATH=./data/mathison

### Genome Configuration (PRODUCTION CRITICAL)
# Path to the verified, signed genome file
# In production: MUST point to a genome signed with a production key
# In development: Can use genomes/TOTK_ROOT_v1.0.0/genome.json (test key)
MATHISON_GENOME_PATH=./genomes/TOTK_ROOT_v1.0.0/genome.json

## Optional Variables

### Server Configuration (mathison-server - CANONICAL PRODUCT API)
# PORT=3000
# HOST=0.0.0.0

### Environment Mode
# Set to 'production' to enable strict mode behaviors
# MATHISON_ENV=production

### Strict Persistence Mode (FAIL-CLOSED in production)
# When enabled (1), persistence failures fail the request deterministically
# Default: 1 in production, 0 in development
# Set to 0 only for development when you need to ignore persistence errors
# MATHISON_STRICT_PERSISTENCE=1

### Build Manifest Verification (production security)
# Set to 'true' to verify build manifest file hashes at boot
# Automatically enabled in production (MATHISON_ENV=production)
# MATHISON_VERIFY_MANIFEST=true

### Repository Root (for manifest verification)
# MATHISON_REPO_ROOT=/path/to/repo

### Job Configuration
# MATHISON_JOB_TIMEOUT=30000
# MATHISON_MAX_CONCURRENT_JOBS=100

### Heartbeat / Self-Audit Configuration
# Interval for periodic system health checks (milliseconds)
# Default: 30000 (30 seconds)
# MATHISON_HEARTBEAT_INTERVAL=30000

### gRPC Configuration (optional)
# Enable gRPC server on specified port
# Default: disabled (HTTP only)
# MATHISON_GRPC_PORT=50051
# MATHISON_GRPC_HOST=0.0.0.0

### Governance Configuration
# Path to governance config (usually ./config/governance.json)
# MATHISON_GOVERNANCE_CONFIG=./config/governance.json

## Sensitive Variables (NEVER COMMIT)

### Genome Signing (for genome generation only, not runtime)
# Only needed when signing genomes, never in production runtime
# GENOME_SIGNING_PRIVATE_KEY=<base64-encoded-private-key>

## Production Notes

1. **mathison-server is the product**: Use `pnpm dev` or `pnpm server` to run the canonical API.

2. **Governance Pipeline**: All routes enforce CIF ingress -> CDI action check -> handler -> CDI output check -> CIF egress.

3. **Fail-closed Behavior**: In production (MATHISON_ENV=production):
   - Missing/invalid genome: DENY boot
   - Missing/invalid config: DENY boot
   - Persistence failures: DENY request (when MATHISON_STRICT_PERSISTENCE=1)
   - Routes without declared action: DENY request

4. **MATHISON_GENOME_PATH**: In production, this MUST point to a genome signed with a production key.

5. **GENOME_SIGNING_PRIVATE_KEY**: This is ONLY used during genome signing operations (via scripts/genome-sign.ts). It should NEVER be set in production runtime environments. Keep private keys in secure secret management systems.

6. **Key Rotation**: When rotating genome signing keys, generate a new keypair, update the genome's authority.signers, re-sign, and deploy the new genome.
