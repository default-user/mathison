# v2.2 No-Bypass Enforcement Specification

## Overview

The No-Bypass rule is a critical security invariant for Mathison v2.2:

> **All vendor model API calls MUST flow through the governed Model Bus. No direct vendor SDK imports or API calls are permitted outside `@mathison/model-bus`.**

This invariant is enforced through CI tests that fail if bypass patterns are detected.

## Enforcement Mechanism

### CI Invariant Test

The test at `packages/mathison-model-bus/tests/no-vendor-bypass.test.ts` scans the entire codebase for bypass patterns.

```typescript
// Patterns that trigger test failure
const VENDOR_SDK_PATTERNS = [
  /from\s+['"]openai['"]/,
  /require\s*\(\s*['"]openai['"]\s*\)/,
  /from\s+['"]@anthropic-ai\/sdk['"]/,
  // ... more patterns
];

const VENDOR_ENDPOINT_PATTERNS = [
  /api\.openai\.com/,
  /api\.anthropic\.com/,
  // ... more patterns
];
```

### What Is Scanned

| Location | Scanned | Allowed |
|----------|---------|---------|
| `packages/mathison-model-bus/src/` | Yes | Yes (this is the only allowed location) |
| `packages/mathison-*/src/` | Yes | **No** (test fails if patterns found) |
| `packages/*/tests/` | No | N/A (test files excluded) |
| `node_modules/` | No | N/A |
| `dist/` | No | N/A |

### Test Behavior

1. **PASS**: No vendor patterns found outside `@mathison/model-bus`
2. **FAIL**: Vendor SDK import or API endpoint found in another package

Example failure message:

```
Vendor SDK imports found outside @mathison/model-bus:
  mathison-server/src/index.ts:
    from\s+['"]openai['"] -> "from 'openai'"

WHY this fails: All vendor API access must go through the governed Model Bus.
Importing vendor SDKs directly bypasses capability enforcement.
```

## Why This Matters

### 1. Capability Enforcement

Without the Model Bus:
```typescript
// WRONG: Direct SDK call bypasses governance
import OpenAI from 'openai';
const client = new OpenAI();
await client.chat.completions.create({...}); // No capability check!
```

With the Model Bus:
```typescript
// CORRECT: Goes through governed handler
const result = await modelRouter.route({
  model_id: 'gpt-4',
  messages: [...],
  capability_token: capToken, // CDI-issued token required
  trace_id: ctx.trace_id,
  namespace_id: 'my-namespace',
});
```

### 2. Audit Trail

Direct calls produce no provenance events. The Model Bus ensures every invocation is logged with:
- Token usage
- Latency
- Trace ID
- Capability token ID

### 3. Centralized Configuration

API keys and endpoints are configured once in the Model Bus, not scattered across the codebase.

### 4. Single Point of Control

Rate limiting, circuit breakers, and error handling can be applied uniformly at the Model Bus level.

## Allowed Patterns

Within `@mathison/model-bus/src/`:

| File | Allowed Pattern |
|------|-----------------|
| `adapters/openai.ts` | `api.openai.com` |
| `adapters/anthropic.ts` | `api.anthropic.com` |
| `http-client.ts` | Generic HTTP calls |

## Adding New Vendor Support

To add a new AI vendor:

1. Create adapter in `packages/mathison-model-bus/src/adapters/newvendor.ts`
2. Add to `adapters/index.ts` exports
3. Register in `router.ts` default adapters
4. Add pattern to router's `findAdapter` logic
5. Update `no-vendor-bypass.test.ts` to expect the new vendor patterns in model-bus

**Never** add vendor SDK imports or API calls outside the model-bus package.

## Running the Test

```bash
# Run only the bypass test
pnpm --filter @mathison/model-bus test -- --testPathPattern=no-vendor-bypass

# Run all model-bus tests
pnpm --filter @mathison/model-bus test
```

## Escape Hatches

There are **no escape hatches**. The no-bypass rule is absolute.

If you believe you have a valid reason to call a vendor API outside the Model Bus:
1. You are probably wrong
2. The correct solution is to extend the Model Bus with a new capability or adapter
3. Discuss with the team before making changes

## False Positives

The test may have false positives in:
- Documentation files (`.md`)
- Comments explaining the architecture
- Test files (excluded by default)

If you encounter a false positive, update the test to exclude that specific case, but document why it's safe.
