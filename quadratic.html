<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mathison Quadratic ‚Äî Browser OI Runtime</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
      background: #0a0a0a;
      color: #0f0;
      padding: 20px;
      line-height: 1.6;
    }

    .header {
      text-align: center;
      padding: 40px 20px;
      border-bottom: 2px solid #0f0;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 0 0 10px #0f0;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.8;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #111;
      border: 1px solid #0f0;
      border-radius: 4px;
      padding: 20px;
    }

    .panel h2 {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #0f0;
      font-size: 1.3em;
    }

    .panel h3 {
      margin-top: 15px;
      margin-bottom: 8px;
      color: #0f0;
      font-size: 1.1em;
    }

    .panel ul {
      margin-left: 20px;
      margin-bottom: 10px;
    }

    .panel li {
      margin-bottom: 5px;
    }

    .panel code {
      background: #000;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
      color: #0ff;
    }

    .panel pre {
      background: #000;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 10px 0;
      color: #0ff;
      font-size: 0.85em;
      border: 1px solid #333;
    }

    .examples button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 8px 16px;
      margin: 5px 5px 5px 0;
      cursor: pointer;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.9em;
      font-weight: bold;
      transition: all 0.2s;
    }

    .examples button:hover {
      background: #0ff;
      box-shadow: 0 0 10px #0ff;
    }

    .examples button:active {
      transform: scale(0.95);
    }

    #oi-mount {
      margin-top: 30px;
    }

    .stage-ladder {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      padding: 15px;
      background: #000;
      border-radius: 4px;
    }

    .stage-ladder .stage {
      padding: 8px 12px;
      background: #111;
      border: 1px solid #333;
      border-radius: 3px;
      font-size: 0.85em;
    }

    .stage-ladder .arrow {
      align-self: center;
      color: #0f0;
      font-size: 1.2em;
    }

    .warning {
      background: #332200;
      border: 1px solid #ff0;
      color: #ff0;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    .success {
      background: #003322;
      border: 1px solid #0f0;
      color: #0f0;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    a {
      color: #0ff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß† MATHISON QUADRATIC</h1>
      <p>Single-file OI Runtime ‚Äî Two-Plane Architecture ‚Äî Growth Ladder Governance</p>
      <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.6;">v0.2.0: LLM ¬∑ Mesh ¬∑ Orchestra ¬∑ Receipt Verification</p>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>üìñ About</h2>
        <p>Quadratic is a self-contained Originating Intelligence (OI) runtime that implements:</p>
        <ul>
          <li><strong>Two-Plane Separation:</strong> Meaning (governance) vs Capability (execution)</li>
          <li><strong>Growth Ladder:</strong> Progressive capability unlock with stage gates</li>
          <li><strong>Receipt Hash Chain:</strong> Tamper-evident action log with replay protection</li>
          <li><strong>Anti-Hive Design:</strong> Namespace isolation, no identity fusion</li>
        </ul>

        <h3>Architecture Planes</h3>
        <p><strong>Plane A (Meaning):</strong> CIF boundary, CDI gating, Memory graph, Receipt verification</p>
        <p><strong>Plane B (Capability):</strong> Memory, Storage, System, Network, LLM, Mesh, Orchestra adapters</p>
      </div>

      <div class="panel">
        <h2>üéØ Quick Start</h2>

        <div class="warning">
          <strong>‚ö†Ô∏è Build Required:</strong> This page expects <code>quad.js</code> to be built from TypeScript.
        </div>

        <p><strong>Build the runtime:</strong></p>
        <pre>cd packages/mathison-quadratic
pnpm install
pnpm build</pre>

        <p><strong>Or use esbuild directly:</strong></p>
        <pre>npx esbuild quad.ts --bundle --format=esm --outfile=../../quad.js</pre>

        <p><strong>Then open this HTML file</strong> in your browser.</p>
      </div>
    </div>

    <div class="panel">
      <h2>üåâ Bridge Connection</h2>
      <p>Connect to a system-side bridge OI to access SYSTEM/NETWORK capabilities from the browser.</p>

      <div style="margin: 15px 0;">
        <input id="bridge-url" type="text" value="http://localhost:3142"
               style="width: 60%; padding: 8px; background: #111; color: #0f0; border: 1px solid #333; font-family: inherit;"
               placeholder="Bridge URL" />
        <button onclick="connectBridge()"
                style="padding: 8px 16px; background: #0f0; color: #000; border: none; cursor: pointer; font-family: inherit; font-weight: bold;">
          Connect
        </button>
        <button onclick="disconnectBridge()"
                style="padding: 8px 16px; background: #f00; color: #fff; border: none; cursor: pointer; font-family: inherit; font-weight: bold; margin-left: 5px;">
          Disconnect
        </button>
      </div>

      <div id="bridge-status" style="padding: 10px; background: #111; border-radius: 4px; font-size: 0.9em;">
        <strong>Status:</strong> <span id="bridge-status-text" style="color: #888;">Not connected</span><br/>
        <div id="bridge-details" style="margin-top: 5px; display: none;">
          <strong>Bridge OI ID:</strong> <span id="bridge-oi-id">-</span><br/>
          <strong>Stage:</strong> <span id="bridge-stage">-</span><br/>
          <strong>Adapters:</strong> <span id="bridge-adapters">-</span><br/>
          <strong>Peers:</strong> <span id="bridge-peers">-</span>
        </div>
      </div>

      <p style="margin-top: 15px; font-size: 0.85em; opacity: 0.7;">
        Start bridge: <code>node quadratic-bridge.js</code>
      </p>
    </div>

    <div class="panel">
      <h2>üìä Growth Ladder</h2>
      <div class="stage-ladder">
        <div class="stage">WINDOW<br/><small>Ephemeral</small></div>
        <div class="arrow">‚Üí</div>
        <div class="stage">BROWSER<br/><small>+ Storage</small></div>
        <div class="arrow">‚Üí</div>
        <div class="stage">SYSTEM<br/><small>+ Filesystem</small></div>
        <div class="arrow">‚Üí</div>
        <div class="stage">NETWORK<br/><small>+ HTTP + LLM</small></div>
        <div class="arrow">‚Üí</div>
        <div class="stage">MESH<br/><small>+ Peers</small></div>
        <div class="arrow">‚Üí</div>
        <div class="stage">ORCHESTRA<br/><small>+ Multi-OI</small></div>
      </div>
      <p><small>Each stage unlocks new actions while preserving all previous capabilities. CDI enforces stage-based allowlists.</small></p>
    </div>

    <div class="grid">
      <div class="panel examples">
        <h2>üß™ Example Actions</h2>

        <h3>Memory Operations</h3>
        <button onclick="sendAction('memory.store', {key: 'name', value: 'Alice'})">Store Memory</button>
        <button onclick="sendAction('memory.recall', {key: 'name'})">Recall Memory</button>
        <button onclick="sendAction('memory.search', {query: 'Alice'})">Search Memory</button>

        <h3>Storage (BROWSER stage)</h3>
        <button onclick="sendAction('storage.save', {key: 'data', value: {test: 123}})">Save Storage</button>
        <button onclick="sendAction('storage.load', {key: 'data'})">Load Storage</button>

        <h3>LLM (NETWORK stage)</h3>
        <button onclick="sendAction('llm.complete', {prompt: 'Hello, introduce yourself'})">LLM Fallback</button>
        <button onclick="sendAction('llm.complete', {prompt: 'Explain quantum computing', model: 'claude-3-haiku-20240307'})">LLM (needs API key)</button>

        <h3>Text Processing</h3>
        <button onclick="sendTextPrompt('What is 2+2?')">Ask Question</button>
        <button onclick="sendTextPrompt('Summarize: The quick brown fox jumps over the lazy dog')">Summarize Text</button>

        <h3>üåâ Bridge Actions (requires bridge)</h3>
        <button onclick="sendBridgeAction('system.exec', {command: 'date'})">System: Date</button>
        <button onclick="sendBridgeAction('system.exec', {command: 'pwd'})">System: PWD</button>
        <button onclick="sendBridgeAction('llm.complete', {prompt: 'Hello from bridge!'})">Bridge LLM</button>
        <button onclick="registerPeer()">Register as Peer</button>
      </div>

      <div class="panel">
        <h2>üîê Security Model</h2>

        <h3>CIF (Contextual Input Filter)</h3>
        <ul>
          <li>Input sanitization and size limits</li>
          <li>Redaction of sensitive patterns</li>
          <li>Prevents injection attacks</li>
        </ul>

        <h3>CDI (Capability Definition Index)</h3>
        <ul>
          <li>Stage-based action allowlists</li>
          <li>Risk threshold enforcement</li>
          <li>Fail-closed by default</li>
        </ul>

        <h3>Receipt Verification</h3>
        <ul>
          <li>SHA-256 hash chain linkage</li>
          <li>Replay attack prevention</li>
          <li>Tamper detection</li>
        </ul>
      </div>
    </div>

    <div class="panel">
      <h2>üéÆ Interactive OI Runtime</h2>
      <p>The OI runtime will mount below. Use the input field to send actions (JSON or text prompts).</p>

      <h3>Example JSON Actions:</h3>
      <pre>{"action": "memory.store", "args": {"key": "test", "value": "hello"}}
{"action": "memory.recall", "args": {"key": "test"}}
{"action": "llm.complete", "args": {"prompt": "What is OI?"}}</pre>

      <h3>Example Text Prompts:</h3>
      <pre>What is 2+2?
Summarize: [your text]
Remember that my name is Alice
What's my name?</pre>
    </div>

    <div id="oi-mount"></div>

    <div class="panel" style="margin-top: 30px;">
      <h2>üìö Resources</h2>
      <ul>
        <li><strong>Documentation:</strong> <code>packages/mathison-quadratic/README.md</code></li>
        <li><strong>Architecture:</strong> <code>packages/mathison-quadratic/ARCHITECTURE.md</code></li>
        <li><strong>Source Code:</strong> <code>packages/mathison-quadratic/quad.ts</code> (1377 lines, single-file monolith)</li>
        <li><strong>CLI Usage:</strong> <code>pnpm quad:selftest</code> or <code>node quad.ts selftest</code></li>
      </ul>
    </div>
  </div>

  <script type="module">
    // Try to import the compiled quad.js module
    let bootBrowser, createOI;

    try {
      const module = await import('./quad.js');
      bootBrowser = module.bootBrowser;
      createOI = module.createOI;
    } catch (error) {
      // If quad.js doesn't exist, show build instructions
      const mount = document.getElementById('oi-mount');
      mount.innerHTML = `
        <div style="background: #330000; border: 2px solid #f00; padding: 30px; border-radius: 4px; text-align: center;">
          <h2 style="color: #f00; margin-bottom: 20px;">‚ùå Runtime Not Found</h2>
          <p style="color: #ff6666; margin-bottom: 20px;">Could not load <code>quad.js</code>. Please build the runtime first:</p>
          <pre style="text-align: left; background: #000; padding: 15px; border-radius: 4px; color: #0ff;">cd packages/mathison-quadratic
npx esbuild quad.ts --bundle --format=esm --outfile=../../quad.js</pre>
          <p style="color: #ff6666; margin-top: 20px;"><small>Error: ${error.message}</small></p>
        </div>
      `;
      throw error;
    }

    // Boot the OI runtime in the browser
    const mount = document.getElementById('oi-mount');
    const oi = bootBrowser({ mount });

    // Make OI available globally for example buttons
    window.quadOI = oi;

    // Helper functions for example buttons
    window.sendAction = async (action, args) => {
      const input = document.querySelector('#input');
      const submit = document.querySelector('#submit');
      if (!input || !submit) return;

      input.value = JSON.stringify({ action, args });
      submit.click();
    };

    window.sendTextPrompt = async (text) => {
      const input = document.querySelector('#input');
      const submit = document.querySelector('#submit');
      if (!input || !submit) return;

      input.value = text;
      submit.click();
    };

    // ============================================================================
    // BRIDGE CONNECTION
    // ============================================================================

    let bridgeURL = null;
    let bridgeConnected = false;

    window.connectBridge = async () => {
      const urlInput = document.getElementById('bridge-url');
      const statusText = document.getElementById('bridge-status-text');
      const details = document.getElementById('bridge-details');

      bridgeURL = urlInput.value.trim();
      if (!bridgeURL) {
        alert('Please enter a bridge URL');
        return;
      }

      try {
        statusText.textContent = 'Connecting...';
        statusText.style.color = '#ff0';

        // Check bridge status
        const response = await fetch(`${bridgeURL}/status`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const status = await response.json();

        // Update UI
        bridgeConnected = true;
        statusText.textContent = 'Connected';
        statusText.style.color = '#0f0';
        details.style.display = 'block';

        document.getElementById('bridge-oi-id').textContent = status.oi_id.slice(0, 16) + '...';
        document.getElementById('bridge-stage').textContent = status.stage;
        document.getElementById('bridge-adapters').textContent = status.adapters.join(', ');
        document.getElementById('bridge-peers').textContent = status.peers_connected;

        console.log('üåâ Bridge connected:', status);

        // Auto-register this browser OI as a peer
        await registerPeerSilent();

      } catch (error) {
        bridgeConnected = false;
        statusText.textContent = `Error: ${error.message}`;
        statusText.style.color = '#f00';
        details.style.display = 'none';
        console.error('Bridge connection failed:', error);
      }
    };

    window.disconnectBridge = () => {
      bridgeConnected = false;
      bridgeURL = null;

      const statusText = document.getElementById('bridge-status-text');
      const details = document.getElementById('bridge-details');

      statusText.textContent = 'Not connected';
      statusText.style.color = '#888';
      details.style.display = 'none';

      console.log('üåâ Bridge disconnected');
    };

    window.sendBridgeAction = async (action, args) => {
      if (!bridgeConnected || !bridgeURL) {
        alert('Bridge not connected. Click "Connect" first.');
        return;
      }

      try {
        const response = await fetch(`${bridgeURL}/dispatch`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-OI-ID': oi.state.oi_id,
          },
          body: JSON.stringify({ action, args }),
        });

        const result = await response.json();

        // Display result in the OI output
        const outputEl = document.querySelector('#output');
        if (outputEl) {
          outputEl.innerHTML += `<div style="margin: 10px 0; padding: 10px; background: #001a1a; border-left: 3px solid ${result.success ? '#0ff' : '#f00'};">
            <strong>üåâ Bridge Action:</strong> ${action}<br/>
            <strong>Args:</strong> ${JSON.stringify(args)}<br/>
            <strong>Result:</strong> ${JSON.stringify(result, null, 2)}
          </div>`;
          outputEl.scrollTop = outputEl.scrollHeight;
        }

        console.log('üåâ Bridge action result:', result);

      } catch (error) {
        alert(`Bridge error: ${error.message}`);
        console.error('Bridge action failed:', error);
      }
    };

    window.registerPeer = async () => {
      if (!bridgeConnected || !bridgeURL) {
        alert('Bridge not connected. Click "Connect" first.');
        return;
      }

      await registerPeerSilent();
      alert('Registered as peer with bridge!');
    };

    async function registerPeerSilent() {
      if (!bridgeURL) return;

      try {
        const response = await fetch(`${bridgeURL}/peer/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            oi_id: oi.state.oi_id,
            address: window.location.href,
            stage: oi.state.stage,
          }),
        });

        const result = await response.json();
        console.log('üåâ Peer registered:', result);

      } catch (error) {
        console.error('Peer registration failed:', error);
      }
    }

    // Display success message
    console.log('üß† Mathison Quadratic OI loaded successfully');
    console.log('OI Instance:', oi);
    console.log('Status:', oi.getStatus());
  </script>
</body>
</html>
